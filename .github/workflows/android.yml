name: Build Android with Gomobile

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch: # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      # 指定 Java 版本
      JAVA_VERSION: '17'
      # 指定 Go 版本
      GO_VERSION: '1.22'

    steps:
    # 1. 检出代码 (替代 git clone)
    # 注意：fetch-depth: 0 和 submodules: recursive 是为了防止之前的子模块错误
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    # 2. 设置 Java 环境 (Gradle 需要)
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    # 3. 设置 Go 环境
    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION }}

    # 4. 安装 Android NDK (Gomobile 必须)
    - name: Setup Android NDK
      run: |
        echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;25.2.9519653"
        # 设置环境变量指向具体的 NDK 版本
        echo "ANDROID_NDK_HOME=$ANDROID_HOME/ndk/25.2.9519653" >> $GITHUB_ENV

    # 5. 安装 Gomobile 工具
    - name: Install Gomobile
      run: |
        go install golang.org/x/mobile/cmd/gomobile@latest
        # 将 GOPATH/bin 添加到 PATH
        echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

    # 6. 初始化 Gomobile
    - name: Initialize Gomobile
      run: gomobile init

    # 7. 执行 Gomobile Bind
    # 您的命令：cd OplusUpdater-Android/OplusUpdater -> gomobile bind ...
    # 这里假设仓库根目录下有一个 OplusUpdater 文件夹
    - name: Run Gomobile Bind
      run: |
        # 根据您的命令，这里生成 .aar 文件
        # 注意：如果您的 go.mod 在子目录，可能需要先 cd 进去
        # 假设 ./OplusUpdater/pkg/updater 是相对于仓库根目录的 Go 包路径
        gomobile bind -target=android -androidapi 26 -v ./OplusUpdater/pkg/updater
      
    # 8. 列出文件以供调试 (可选)
    # 这一步可以帮您确认生成的 .aar 文件在哪里，以及 gradlew 是否存在
    - name: Debug File Structure
      run: ls -R

    # 9. 赋予 Gradle 执行权限并构建
    # 您的命令：cd .. -> ./gradlew assemble
    - name: Build with Gradle
      run: |
        chmod +x gradlew
        ./gradlew assembleDebug
        # 如果需要 Release 包，请使用 ./gradlew assembleRelease

    # 10. 上传构建产物 (APK)
    - name: Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-debug
        path: app/build/outputs/apk/debug/*.apk
        # 如果路径不同，请根据第 8 步的日志调整 path

    # 11. 上传 AAR 产物 (可选，如果您只想要 gomobile 生成的库)
    - name: Upload AAR Artifact
      uses: actions/upload-artifact@v4
      with:
        name: gomobile-aar
        path: ./*.aar
